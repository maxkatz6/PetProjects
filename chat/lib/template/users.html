<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Пользователи</title>
    <style>
        .selected.asc:after {
            content: '\25bc';
        }
        .selected.desc::after {
            content: '\25b2';
        }
        th {
            background-color: #0c95d9;
            color: #fff;
            padding: 4px;
            text-align: center;
        }
        td {
            padding: 10px 20px;
            text-align: center;
            font-family: Verdana, Arial, Helvetica, sans-serif;
        }
        tr.odd {
            background-color: #e1eaf2;
        }
        tr.even {
            background-color: #eaf1f6;
        }
    </style>
    <script src="js/helper.js?[VN/]" type="text/javascript" charset="UTF-8"></script>
    <script type="text/javascript">
        function updateTable(page, sortBy, isASC) {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
                    renderTable(JSON.parse(xmlHttp.responseText));
            }
            xmlHttp.open(
                "GET",
                "/chat/?ajax&view=users&page=" + page + "&sortBy=" + sortBy + (isASC ? "&asc" : ""),
                true);
            xmlHttp.send(null);
        }

        function sortClick(item) {
            var type = item.getAttribute("data-type");
            var lastSort = item.getAttribute("data-sort") || "asc";
            item.className = item.className.replace(/ asc| desc/g, "");

            if (lastSort == "asc") {
                lastSort = "desc";
                item.setAttribute("data-sort", lastSort);
                item.className += " " + lastSort;
            }
            else {
                lastSort = "asc";
                item.setAttribute("data-sort", lastSort);
                item.className += " " + lastSort;
            }

            var headers = document.getElementsByTagName("th");
            for (var i = 0; i < headers.length; i++)
                headers[i].className = headers[i].className.replace(" selected", "");

            item.className += " selected";

            updateTable(0, type, lastSort == "asc");
        }
        
        function renderTable(json) {
            var users = json["users"];
            var table = document.getElementById("users");
            table.innerHTML = "";
            for (var i = 0; i < users.length; i++) {
                var user = users[i];
                table.innerHTML += "<tr class='" + (i % 2 == 0 ? "even" : "odd") + "'>" +
                    "<td>" + user["username"] + "</td>" +
                    (user["tim"] != "none" ?  ("<td><img src='img/tim/" + user["tim"] + ".png' border='0' title='" + helper.getTIM(user["tim"]) + "'></img></td>") : "<td>-</td>") +
                    "<td>" + getDate(user["registerDate"]) + "</td>" +
                    "<td>" + getDate(user["lastvisitDate"])  + "</td>" +
                    "<td>" + user["msgCount"] + "</td>" +
                    "<td>" + user["minutesInChat"] + "</td>" +
                "</tr>";
            }
        }

        function getDate(long) {
            if (long && long > 0) {
                var date = new Date(long * 1000);
                return (date.getDate() < 9 ? "0" : "") + date.getDate() + "-" +
                    (date.getMonth() < 9 ? "0" : "") + (date.getMonth() + 1) + "-" +
                    date.getFullYear();
            }
            return "никогда";
        }
    </script>
</head>
<body>
    <table>
        <thead>            
            <tr>
                <th data-type='username' onclick='sortClick(this)'>Ник</th>                
                <th data-type='tim' onclick='sortClick(this)'>ТИМ</th>                
                <th data-type='registerDate' onclick='sortClick(this)'>Дата регистрации</th>                
                <th data-type='lastvisitDate' onclick='sortClick(this)'>Последний вход</th>                
                <th data-type='msgCount' onclick='sortClick(this)'>Сообщений</th>                
                <th data-type='minutesInChat' onclick='sortClick(this)'>Время в чате</th>                
            </tr>
        </thead>
        <tbody id="users">

        </tbody>
    </table>
    <script type="text/javascript">
        renderTable(JSON.parse('[USERS_JSON/]'));
    </script>
</body>
</html>